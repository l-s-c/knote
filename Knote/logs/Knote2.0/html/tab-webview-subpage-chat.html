<!DOCTYPE html>
<html>

	<head>
		<meta charset="utf-8">
		<title>Hello MUI</title>
		<meta name="viewport" content="width=device-width, initial-scale=1,maximum-scale=1,user-scalable=no">
		<meta name="apple-mobile-web-app-capable" content="yes">
		<meta name="apple-mobile-web-app-status-bar-style" content="black">
		<link rel="stylesheet" href="https://cdn.staticfile.org/twitter-bootstrap/3.3.7/css/bootstrap.min.css">
		<link rel="stylesheet" href="../css/mui.min.css">
		<script type="text/javascript" src="../js/common.js" ></script>
		<style>
			html,
			body {
				background-color: #efeff4;
			}
			
			.title {
				padding: 20px 15px 10px;
				color: #6d6d72;
				font-size: 15px;
				background-color: #fff;
			}
			.mui-scroll-wrapper {
		     overflow: visible; 
			}
		</style>
	</head>

	<body>
		<header class="mui-bar mui-bar-nav">
			<h1 class="mui-title">浏览笔记页</h1>
			<button style="float: right;" onclick="clicked('barcode_scan.html',true,true)">扫哟</button>
		</header>
		<div id="pullrefresh" class="mui-content mui-scroll-wrapper">
			<div class="mui-scroll">
		
			<div id="allNote">
				<div class="panel panel-default">
					<div class="panel-body">
						[标题]
					</div>
					<div class="panel-footer"><span>[标签]</span><span>[标签2]</span></div>
				</div>
				<div class="panel panel-default">
					<div class="panel-body">
						[标题]
					</div>
					<div class="panel-footer"><span>[标签]</span><span>[标签2]</span></div>
				</div>
			</div>
			</div>
		</div>
		<script src="../js/mui.min.js"></script>
		<script type="text/javascript" src="../js/jquery-2.1.0.js" ></script>
		<script type="text/javascript" src="../js/json.js" ></script>
		<script>
			var ip;					//ip地址
			var flag = false;		//下来加载参数，为true代表没有新内容了
			var seeNote = {
				//请求地址
				URL:{
					loadNote:function(){
						return ip+"note/loadNote";
					},
					loadAfterNote:function(){
						return ip+"note/loadAfterNote";
					}
				},
				//跳转页面
				tranceForm:function(id){
				//	window.open("noteDesc.html?id="+id);
				plus.webview.open('noteDesc.html?id='+id, 'new', {}, 'slide-in-right', 200);
				},
				//随机加载页面20条数据
				loadNote:function (){
					var url = seeNote.URL.loadNote();
					$.get(url,function(res){
						console.log(res);
						if(res.code==1){
							seeNote.addNote(res.data);
						}else{
							alert(res.msg);
						}
					});
				},
				//界面初始数据
				addNote:function(data){
					var div = '	<div class="panel panel-default" id="[id]" onclick="seeNote.tranceForm(this.id);">'
						+	'	<div class="panel-body">'
						+	'	[title]'
						+	'	</div>'
						+	'	<div class="panel-footer"><span>[lable]</span></div>'
						+	'	</div>';
					$('#allNote').empty();
					for(var i=0;i<data.length;i++){
						var d = div.replace("[id]",data[i].id)
								   .replace("[title]",data[i].noteTitle)
								   .replace("[lable]",data[i].label);
						$('#allNote').append(d);
					}
				},
				//下拉加载追加数据
				loadAfterNote:function (prefix,suffix){
					var url = seeNote.URL.loadAfterNote();
					var params = {
						prefix : prefix,
						suffix : suffix
					};
					$.post(url,params,function(res){
						console.log(res);
						if(res.code==1){
							seeNote.addAfterNote(res.data);
						}else{
							alert(res.msg);
						}
					});
				},
				//追加数据
				addAfterNote:function(data){
					if(data.length<=0){
						flag = true;
					}
					mui('#pullrefresh').pullRefresh().endPullupToRefresh((flag)); //参数为true代表没有更多数据了。
					var table = document.getElementById('allNote');
					for(var i = 0; i< data.length; i++) {
						var div = document.createElement('div');
						div.className = 'panel panel-default';
						div.innerHTML = 
						'<div class="panel-body" id="'+data[i].id+'">'
						+data[i].noteTitle+'</div><div class="panel-footer"><span>'
						+data[i].label+'</span></div>';
						table.appendChild(div);
					}
				}
			};
			$(function(){
				ip = getIP();
				seeNote.loadNote();
			});
			mui.init({
				swipeBack: false,
				pullRefresh: {
					container: '#pullrefresh',
					down: {
						style:'circle',
						callback: pulldownRefresh
					},
					up: {
						contentrefresh: '正在加载...',
						callback: pullupRefresh
					}
				}
			});
			/**
			 * 下拉刷新具体业务实现
			 */
			function pulldownRefresh() { 
				//查询
				setTimeout(function() {
				/*	var table = document.getElementById('allNote');
					var cells = document.body.querySelectorAll('.panel panel-default');
					for(var i = cells.length, len = i + 3; i < len; i++) {
						var div = document.createElement('div');
						div.className = 'panel panel-default';
						div.innerHTML = 
						'<div class="panel-body">[标题]</div><div class="panel-footer"><span>[标签]</span><span>[标签2]</span></div>';
						//下拉刷新，新纪录插到最前面；
						table.insertBefore(div, table.firstChild);
					}
					mui('#pullrefresh').pullRefresh().endPulldownToRefresh(); //refresh completed
					mui.toast('下拉刷新成功');*/
					seeNote.loadNote();
					mui('#pullrefresh').pullRefresh().endPulldownToRefresh(); 
					mui.toast('刷新成功');
				}, 1000);
			}
			/**
			 * 上拉加载具体业务实现
			 */
			function pullupRefresh() {
				setTimeout(function() {
					var cells = $('.panel-body');
					var prefix = cells.length;
					console.log(cells.length)
					var suffix = prefix + 20;
					seeNote.loadAfterNote(prefix,suffix);
					
				}, 1000);
			}
		</script>
	</body>

</html>